name: Build Installers

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
    paths:
      - 'VERSION'  # Only trigger when VERSION file changes
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write  # Required for creating releases and uploading assets

env:
  PRODUCT_NAME: "Verification GenAI"
  PRODUCT_SHORT_NAME: "verification-genai"

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual workflow dispatch
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            # Tag push (v1.0.0)
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            # Push to main - read from VERSION file
            VERSION=$(cat VERSION)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected format: MAJOR.MINOR.PATCH (e.g., 1.0.0 or 1.0.0-beta.1)"
            exit 1
          fi
          echo "Version format valid: $VERSION"

      - name: Check if release exists
        id: check_release
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          echo "Checking for release with tag: $TAG"

          # Use GitHub API to check if release exists
          HTTP_CODE=$(curl -s -o /tmp/release.json -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "Release $TAG already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
            UPLOAD_URL=$(cat /tmp/release.json | jq -r .upload_url)
            echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT
          else
            echo "Release $TAG does not exist (HTTP $HTTP_CODE)"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        id: create_release
        if: steps.check_release.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v$VERSION"

          gh release create "$TAG" \
            --title "Release v$VERSION" \
            --notes "# GenAI Research v$VERSION

          ## Installation

          ### Windows
          Download and run \`genai-research-$VERSION.msi\`

          ### Linux (Debian/Ubuntu)
          \`\`\`bash
          sudo dpkg -i genai-research_${VERSION}_amd64.deb
          sudo apt-get install -f  # Install dependencies if needed
          \`\`\`

          ### Linux (RHEL/CentOS/Fedora)
          \`\`\`bash
          sudo rpm -i genai-research-$VERSION.x86_64.rpm
          \`\`\`

          ### macOS
          Open \`genai-research-$VERSION.dmg\` and drag to Applications

          ## Prerequisites
          - Docker 24.0.0 or later
          - Docker Compose 2.20.0 or later
          - 8 GB RAM minimum
          - 50 GB disk space
          - 4 CPU cores recommended

          ## What's New
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows Installer
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install WiX Toolset
        run: |
          choco install wixtoolset -y
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Create staging directory
        shell: pwsh
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          $stagingDir = "installer/windows/staging"

          # Create staging directory
          New-Item -ItemType Directory -Path $stagingDir -Force | Out-Null

          # Copy application files
          Copy-Item -Recurse src $stagingDir
          Copy-Item -Recurse scripts $stagingDir
          Copy-Item -Recurse installer/windows/scripts/* $stagingDir/scripts -Force
          Copy-Item docker-compose.yml $stagingDir
          Copy-Item Dockerfile.base $stagingDir
          Copy-Item .env.template $stagingDir
          Copy-Item VERSION $stagingDir
          Copy-Item CHANGELOG.md $stagingDir
          Copy-Item README.md $stagingDir
          Copy-Item INSTALL.md $stagingDir
          Copy-Item LICENSE.rtf $stagingDir
          Copy-Item poetry.lock $stagingDir
          Copy-Item pyproject.toml $stagingDir

          Write-Host "Staging directory created with all files"
          Get-ChildItem -Path $stagingDir -Recurse | Select-Object -First 20

      - name: Harvest files with heat.exe
        shell: pwsh
        run: |
          cd installer/windows

          # Use heat to harvest the staging directory
          & heat.exe dir staging `
            -cg ApplicationFiles `
            -gg `
            -sfrag `
            -srd `
            -dr INSTALLFOLDER `
            -var "var.StagingDir" `
            -out FilesFragment.wxs

          if ($LASTEXITCODE -ne 0) {
            Write-Error "heat.exe failed"
            exit 1
          }

          Write-Host "Files harvested successfully"

      - name: Update version in WiX
        shell: pwsh
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          $stagingPath = (Resolve-Path "installer/windows/staging").Path

          # Update Product.wxs
          (Get-Content installer/windows/Product.wxs) -replace 'VERSION_PLACEHOLDER', $version | Set-Content installer/windows/Product_build.wxs

          # Copy icon file to installer directory if it exists
          if (Test-Path "installer/windows/app-icon.ico") {
              Write-Host "Icon file found, will be included in installer"
          } else {
              Write-Host "Warning: Icon file not found at installer/windows/app-icon.ico"
          }

          Write-Host "Version updated to: $version"
          Write-Host "Staging path: $stagingPath"

      - name: Build WiX installer
        shell: pwsh
        run: |
          cd installer/windows
          $stagingPath = (Resolve-Path "staging").Path
          $version = "${{ needs.prepare.outputs.version }}"

          Write-Host "Building MSI with staging path: $stagingPath"

          # Compile Product.wxs
          & candle.exe Product_build.wxs `
            -dStagingDir="$stagingPath" `
            -dVersion=$version `
            -arch x64 `
            -ext WixUIExtension `
            -ext WixUtilExtension

          if ($LASTEXITCODE -ne 0) {
            Write-Error "candle.exe failed for Product.wxs"
            exit 1
          }

          # Compile FilesFragment.wxs
          & candle.exe FilesFragment.wxs `
            -dStagingDir="$stagingPath" `
            -dVersion=$version `
            -arch x64 `
            -ext WixUIExtension `
            -ext WixUtilExtension

          if ($LASTEXITCODE -ne 0) {
            Write-Error "candle.exe failed for FilesFragment.wxs"
            exit 1
          }

          # Compile CustomUI.wxs
          & candle.exe CustomUI.wxs `
            -dStagingDir="$stagingPath" `
            -dVersion=$version `
            -arch x64 `
            -ext WixUIExtension `
            -ext WixUtilExtension

          if ($LASTEXITCODE -ne 0) {
            Write-Error "candle.exe failed for CustomUI.wxs"
            exit 1
          }

          # Link to create MSI
          & light.exe Product_build.wixobj FilesFragment.wixobj CustomUI.wixobj `
            -out ../../genai-research-$version.msi `
            -ext WixUIExtension `
            -ext WixUtilExtension `
            -cultures:en-US

          if ($LASTEXITCODE -ne 0) {
            Write-Error "light.exe failed"
            exit 1
          }

          Write-Host "MSI built successfully"

      - name: Upload Windows Installer
        shell: pwsh
        run: |
          $VERSION = "${{ needs.prepare.outputs.version }}"
          $TAG = "v$VERSION"
          $ASSET_PATH = "genai-research-$VERSION.msi"

          # Delete existing asset if it exists
          gh release delete-asset $TAG $ASSET_PATH -y -R ${{ github.repository }} 2>$null

          # Upload new asset
          gh release upload $TAG $ASSET_PATH -R ${{ github.repository }} --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux-deb:
    name: Build Linux DEB Package
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev build-essential

      - name: Prepare DEB package structure
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          PKG_DIR="genai-research_${VERSION}_amd64"

          # Create directory structure
          mkdir -p "$PKG_DIR/opt/genai-research"
          mkdir -p "$PKG_DIR/DEBIAN"

          # Copy application files
          cp -r src "$PKG_DIR/opt/genai-research/"
          cp -r scripts "$PKG_DIR/opt/genai-research/"
          cp docker-compose.yml "$PKG_DIR/opt/genai-research/"
          cp .env.template "$PKG_DIR/opt/genai-research/.env"
          cp VERSION "$PKG_DIR/opt/genai-research/"
          cp CHANGELOG.md "$PKG_DIR/opt/genai-research/"
          cp README.md "$PKG_DIR/opt/genai-research/"
          cp INSTALL.md "$PKG_DIR/opt/genai-research/"

          # Copy DEBIAN control files
          cp installer/linux/DEBIAN/* "$PKG_DIR/DEBIAN/"

          # Update version in control file
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" "$PKG_DIR/DEBIAN/control"

          # Set permissions
          chmod 755 "$PKG_DIR/DEBIAN/postinst"
          chmod 755 "$PKG_DIR/DEBIAN/prerm"
          chmod 755 "$PKG_DIR/DEBIAN/postrm"

          # Build DEB package
          dpkg-deb --build "$PKG_DIR"

      - name: Upload Linux DEB Package
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="v$VERSION"
          ASSET_PATH="genai-research_${VERSION}_amd64.deb"

          # Upload with clobber to replace if exists
          gh release upload "$TAG" "$ASSET_PATH" -R ${{ github.repository }} --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux-rpm:
    name: Build Linux RPM Package
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install RPM tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Copy RPM post-install script
        run: |
          # Copy the RPM postinst script to scripts directory
          cp installer/linux/rpm-postinst.sh scripts/

      - name: Create RPM spec file
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          cat > genai-research.spec <<'SPECEOF'
          Name:           genai-research
          Version:        %{_version}
          Release:        1%{?dist}
          Summary:        AI-powered research and verification system
          License:        Proprietary
          URL:            https://github.com/${{ github.repository }}
          Source0:        %{name}-%{version}.tar.gz
          Requires:       docker >= 24.0.0
          BuildArch:      x86_64

          %description
          GenAI Research provides comprehensive AI-powered research and
          verification capabilities using advanced AI models. Features include:
          - Multi-agent test plan generation with Actor-Critic system
          - RAG-enhanced document analysis with citation tracking
          - Test card creation with Word export
          - Support for cloud LLMs (OpenAI) and local models (Ollama)
          - US-based model compliance (Meta, Microsoft, Snowflake)
          - Complete on-premises deployment option

          %prep
          %setup -q -n %{name}-%{version}

          %build
          # No build needed - Python/Docker application

          %install
          mkdir -p %{buildroot}/opt/genai-research
          cp -r src %{buildroot}/opt/genai-research/
          cp -r scripts %{buildroot}/opt/genai-research/
          cp docker-compose.yml %{buildroot}/opt/genai-research/
          cp .env.template %{buildroot}/opt/genai-research/.env
          cp VERSION %{buildroot}/opt/genai-research/
          cp CHANGELOG.md %{buildroot}/opt/genai-research/
          cp README.md %{buildroot}/opt/genai-research/
          cp INSTALL.md %{buildroot}/opt/genai-research/

          %files
          %defattr(-,root,root,-)
          /opt/genai-research

          %post
          # Run post-installation script
          if [ -f /opt/genai-research/scripts/rpm-postinst.sh ]; then
              bash /opt/genai-research/scripts/rpm-postinst.sh
          fi

          %preun
          # Stop and disable service before uninstall
          if systemctl is-active --quiet genai-research; then
              systemctl stop genai-research
          fi
          if systemctl is-enabled --quiet genai-research; then
              systemctl disable genai-research
          fi

          %postun
          # Remove systemd service file on purge
          if [ $1 -eq 0 ]; then
              rm -f /etc/systemd/system/genai-research.service
              systemctl daemon-reload
          fi

          %changelog
          * $(date +'%a %b %d %Y') GitHub Actions <actions@github.com> - %{version}-1
          - Release %{version}
          SPECEOF

          # Replace version placeholder
          sed -i "s/%{_version}/$VERSION/g" genai-research.spec

      - name: Build RPM package
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp genai-research.spec ~/rpmbuild/SPECS/

          # Create source tarball with proper directory structure
          mkdir -p genai-research-$VERSION
          cp -r src scripts docker-compose.yml .env.template VERSION CHANGELOG.md README.md INSTALL.md genai-research-$VERSION/
          tar czf ~/rpmbuild/SOURCES/genai-research-$VERSION.tar.gz genai-research-$VERSION
          rm -rf genai-research-$VERSION

          # Build RPM
          rpmbuild -ba ~/rpmbuild/SPECS/genai-research.spec

          # Copy built RPM
          find ~/rpmbuild/RPMS -name "*.rpm" -exec cp {} ./ \;

      - name: Find and upload RPM
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          RPM_FILE=$(ls genai-research-$VERSION-*.x86_64.rpm | head -1)
          echo "RPM_FILE=$RPM_FILE" >> $GITHUB_ENV

      - name: Upload Linux RPM Package
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="v$VERSION"
          RPM_FILE="${{ env.RPM_FILE }}"

          # Upload with clobber to replace if exists, rename to standard name
          gh release upload "$TAG" "$RPM_FILE#genai-research-$VERSION.x86_64.rpm" -R ${{ github.repository }} --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS DMG
    needs: prepare
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create DMG
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          APP_NAME="GenAI Research"
          DMG_NAME="genai-research-$VERSION.dmg"

          # Create app bundle structure
          mkdir -p "build/$APP_NAME.app/Contents/MacOS"
          mkdir -p "build/$APP_NAME.app/Contents/Resources"

          # Copy application files
          cp -r src "build/$APP_NAME.app/Contents/Resources/"
          cp -r scripts "build/$APP_NAME.app/Contents/Resources/"
          cp docker-compose.yml "build/$APP_NAME.app/Contents/Resources/"
          cp .env.template "build/$APP_NAME.app/Contents/Resources/.env"
          cp VERSION "build/$APP_NAME.app/Contents/Resources/"
          cp CHANGELOG.md "build/$APP_NAME.app/Contents/Resources/"
          cp README.md "build/$APP_NAME.app/Contents/Resources/"

          # Create Info.plist
          cat > "build/$APP_NAME.app/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>GenAI Research</string>
              <key>CFBundleVersion</key>
              <string>$VERSION</string>
              <key>CFBundleShortVersionString</key>
              <string>$VERSION</string>
              <key>CFBundleExecutable</key>
              <string>launcher</string>
          </dict>
          </plist>
          EOF

          # Create launcher script with setup
          cat > "build/$APP_NAME.app/Contents/MacOS/launcher" <<'EOF'
          #!/bin/bash
          RESOURCES_DIR="$(dirname "$0")/../Resources"
          cd "$RESOURCES_DIR"

          # Run setup on first launch if .env doesn't exist
          if [ ! -f "$RESOURCES_DIR/.env" ] || [ ! -s "$RESOURCES_DIR/.env" ]; then
              osascript -e 'tell app "Terminal" to do script "cd '"$RESOURCES_DIR"' && ./scripts/setup-env.sh"'
              exit 0
          fi

          # Check if Docker is running
          if ! docker info &> /dev/null; then
              osascript -e 'display dialog "Docker Desktop is not running. Please start Docker Desktop first." buttons {"OK"} default button "OK"'
              open -a "Docker"
              exit 1
          fi

          # Start services
          docker compose up -d

          # Wait for services
          sleep 5

          # Open web interface
          open http://localhost:8501
          EOF
          chmod +x "build/$APP_NAME.app/Contents/MacOS/launcher"

          # Create setup script launcher
          cat > "build/$APP_NAME.app/Contents/MacOS/setup" <<'EOF'
          #!/bin/bash
          RESOURCES_DIR="$(dirname "$0")/../Resources"
          cd "$RESOURCES_DIR"
          osascript -e 'tell app "Terminal" to do script "cd '"$RESOURCES_DIR"' && ./scripts/setup-env.sh && exit"'
          EOF
          chmod +x "build/$APP_NAME.app/Contents/MacOS/setup"

          # Create DMG
          hdiutil create -volname "$APP_NAME" -srcfolder build -ov -format UDZO "$DMG_NAME"

      - name: Upload macOS DMG
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="v$VERSION"
          ASSET_PATH="genai-research-$VERSION.dmg"

          # Upload with clobber to replace if exists
          gh release upload "$TAG" "$ASSET_PATH" -R ${{ github.repository }} --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  checksums:
    name: Generate Checksums
    needs: [prepare, build-windows, build-linux-deb, build-linux-rpm, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release assets
        run: |
          TAG="v${{ needs.prepare.outputs.version }}"
          VERSION="${{ needs.prepare.outputs.version }}"

          # Download all release assets
          gh release download "$TAG" --pattern "*.msi" -R ${{ github.repository }} || true
          gh release download "$TAG" --pattern "*.deb" -R ${{ github.repository }} || true
          gh release download "$TAG" --pattern "*.rpm" -R ${{ github.repository }} || true
          gh release download "$TAG" --pattern "*.dmg" -R ${{ github.repository }} || true

          ls -la
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate checksums
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          # Wait a bit for uploads to complete
          echo "Waiting for assets to be uploaded..."
          sleep 10

          # Download again to make sure we have the latest
          TAG="v$VERSION"
          gh release download "$TAG" --pattern "*.msi" -R ${{ github.repository }} --clobber || true
          gh release download "$TAG" --pattern "*.deb" -R ${{ github.repository }} --clobber || true
          gh release download "$TAG" --pattern "*.rpm" -R ${{ github.repository }} --clobber || true
          gh release download "$TAG" --pattern "*.dmg" -R ${{ github.repository }} --clobber || true

          ls -la

          # Generate checksums only for files that exist
          rm -f checksums-sha256.txt
          [ -f "genai-research-$VERSION.msi" ] && sha256sum genai-research-$VERSION.msi >> checksums-sha256.txt
          [ -f "genai-research_${VERSION}_amd64.deb" ] && sha256sum genai-research_${VERSION}_amd64.deb >> checksums-sha256.txt
          [ -f "genai-research-$VERSION.x86_64.rpm" ] && sha256sum genai-research-$VERSION.x86_64.rpm >> checksums-sha256.txt
          [ -f "genai-research-$VERSION.dmg" ] && sha256sum genai-research-$VERSION.dmg >> checksums-sha256.txt

          if [ -f checksums-sha256.txt ]; then
            cat checksums-sha256.txt
          else
            echo "No files found to checksum"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload checksums
        if: hashFiles('checksums-sha256.txt') != ''
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="v$VERSION"

          # Upload with clobber to replace if exists
          gh release upload "$TAG" checksums-sha256.txt -R ${{ github.repository }} --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
